<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="style.css">
	<title>File</title>
</head>
<body>
	<!-- 导航栏 开始 -->
	<nav class="navbar navbar-default navbar-fixed-top" style="z-index: 100;">
		<div class="container">
			<div class="navbar-header">
				<a href="#" class="navbar-brand logo"><img src="img/logo.jpg" width="162px" height="50px" alt="altalt"></a>
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
					<!-- 三根线 -->
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
			</div>
			<div class="collapse navbar-collapse" id="navbar-collapse">
				<ul class="nav navbar-nav navbar-right">
					<li>
						<a href="index.html"><span class="glyphicon glyphicon-home"></span> Index</a>
					</li>
					<li>
						<a href="history.html"><span class="glyphicon glyphicon-time"></span> History</a>
					</li>
					<li class="active">
						<a href="file.html"><span class="glyphicon glyphicon-file"></span> File</a>
					</li>
				</ul>
			</div>
		</div>
	</nav>
	<!-- 导航栏 结束 -->

	<!-- 路径 开始-->
	<nav class="navbar navbar-default navbar-fixed-top navbar_path" style="z-index: 99;">
		<!-- <div id="path_bg" class="container"> -->
		<div class="container">
			<div class="row">
				<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
					<div class="input-group">
						<div class="input-group-btn">
					  		<button type="button" id="proRoot" class="btn btn-default" onclick="goBack()" title="/cmd">/cmd</button>
							<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span></button>
							<ul class="dropdown-menu">
							  <li><a href="javascript:void(0)" onclick="onClickRootPath(this)">/cmd</a></li> 
							  <li><a href="javascript:void(0)" onclick="onClickRootPath(this)">/web</a></li> 
							  <li><a href="javascript:void(0)" onclick="onClickRootPath(this)">/data</a></li>
							  <li><a href="javascript:void(0)" onclick="onClickRootPath(this)">/access</a></li>
							</ul>
				         </div><!-- /btn-group -->
					  <input id="proName" type="text" class="form-control" id="basic-url" aria-describedby="basic-addon3" placeholder="" title="">
					  <span class="input-group-btn">
					  	<button class="btn btn-default" type="button" onclick="onClickRefresh()">
					  		<span class="glyphicon glyphicon-refresh"></span>
					  	</button>
					  </span>
					</div>
				</div>
			</div>
			<div id="alertTips" class="alert alert-warning fade in hidden" style="margin-top: 10px;"></div>
		</div>
	</nav>
	<!-- 路径 结束 -->

	<!-- Delete 弹出框 -->
	<div class="modal" id="modalDelete" tabindex="-1" role="dialog" aria-labelledby="deleteLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" aria-hidden="true" id="deleteClose">&times;</button>
					<h4 class="modal-title">Tips</h4>
				</div>
				<div class="modal-body" id="modalDeleteBody">
					<span> 确定要 <span style="color: #f00;">删除</span> 这些文件吗?</span>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" id="deleteYES">YES</button>
					<button type="button" class="btn btn-primary" id="deleteNo">No</button>
				</div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal -->
	</div>
	<!-- Delete 弹出框 结束-->

	<!-- Upload 弹出框 -->
	<div class="modal" id="modalUpload" tabindex="-1" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" aria-hidden="true" id="uploadClose">&times;</button>
					<h4 class="modal-title" id="uploadTitle">Upload</h4>
				</div>
				<div class="modal-body" id="modalUploadBody">
					<form id="uploadFile_form" role="form" action="" method="POST" enctype="multipart/form-data">
						<input  type="file" multiple="multiple" id="uploadChoosefile" name="file"/>
						<br/>
						<div class="progress">
						  <div id="uploadProgressbar" class="progress-bar" role="progressbar" style="width: 60%;"><span id="uploadProgressValue">90%</span></div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<span id="uploadTips" class="label label-danger"></span>
					<button type="button" class="btn btn-default" id="uploadYES">Upload</button>
					<button type="button" class="btn btn-primary" id="uploadNo">Cancel</button>
				</div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal -->
	</div>
	<!-- Upload 弹出框 结束-->

	<!-- 文件列表 开始 -->
	<div id="filelist_bg" class="container">
		<table class="table">
		  <thead>
		    <tr>
		      <th><input id="itemSelectedAll" type="checkbox" onclick="onClickSelectAll(this)"></th>
		      <th>Name</th>
		      <th>Options</th>
		    </tr>
		  </thead>
		  <tbody id="filelistBody">
		  </tbody>
		</table>
	</div>
	<!-- 文件列表 结束 -->
	
	<!-- 底部 开始 -->
	<footer id="footer_files" class="navbar-fixed-bottom">
		<div class="container">
			<div class="row">
				<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
					<div id="bgBtnConfirm">
						<button id="btnConfirm" class="btn btn-info" type="button" onclick="onClickConfirm(this)">Confirm</button>
					</div>
				</div>
				<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
					<div id="bgSpanCount">
						<span id="spanCount" class="label label-warning">0/0</span>
					</div>
				</div>
				<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
					<div class="dropup" id="bgOption">
						<button class="btn btn-info dropdown-toggle" type="button" id="dropdownOption" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span id="spanOption">Delete</span>&nbsp;&nbsp;<span class="caret"></span></button>
						<ul id="bgListOptions" class="dropdown-menu dropdown-menu-left" aria-labelledby="dropdownOption">
							<li><a href="javascript:void(0)" onclick="onClickListOption(this)">Delete</a></li>
							<li role="separator" class="divider"></li>
							<li><a href="javascript:void(0)" onclick="onClickListOption(this)">Upload</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</footer>
	<!-- 底部 结束 -->

	<!-- 先让网页显示出来，再加载js -->
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="IP.js" charset="utf-8"></script>
	<script type="text/javascript">
		 
		var gJObjFileList;
		var gIsDeleting = false;
		var gIsUploading = false;

		var gIsCompressing = false;
		var gIsMoveCpying  = false;

		function isBusy()
		{
			var result = gIsDeleting || gIsUploading || gIsCompressing || gIsMoveCpying;
			console.log("isBusy() - " + result);
			return result;
		}

		$(window).load(function() {
		 	//footer_files 居中
			$('#bgBtnConfirm').css('margin-top', (($('#footer_files').height() - $('#bgBtnConfirm').height()) * 0.5) + 'px');
			$('#bgOption').css('margin-top', (($('#footer_files').height() - $('#bgOption').height()) * 0.5) + 'px');
			$('#bgSpanCount').css('margin-top', (($('#footer_files').height() - $('#bgSpanCount').height()) * 0.5) + 'px');
			//5px 适配，button自带margin

			//album_bg
			$('#filelist_bg').css('margin-bottom', $('#footer_files').height() + 'px')

			// //弹出框显示在中间
			// $('#myModal').on('shown.bs.modal', function (e) {
	  //           // 关键代码，如没将modal设置为 block，则$modala_dialog.height() 为零
	  //           $(this).css('display', 'block');
	  //           var modalHeight = $(window).height() / 2 - $('#myModal .modal-dialog').height() / 2;
	  //           $(this).find('.modal-dialog').css({'margin-top': modalHeight});
   //     		});

			//更新 按钮的大小
       		// updateItemBtnsSize();
       		// initDev();
       		refreshFileList();

		});

		$(window).resize(function() {
			console.log("---------resize()------");
			//footer_capture 居中
			$('#bgBtnConfirm').css('margin-top', (($('#footer_files').height() - $('#bgBtnConfirm').height()) * 0.5) + 'px');
			$('#bgOption').css('margin-top', (($('#footer_files').height() - $('#bgOption').height()) * 0.5) + 'px');
			$('#bgSpanCount').css('margin-top', (($('#footer_files').height() - $('#bgSpanCount').height()) * 0.5) + 'px');

			//album_bg
			$('#filelist_bg').css('margin-bottom', $('#footer_files').height() + 'px');

			updateItemBtnsSize();

		});

		function refreshFileList()
		{
			console.log("refreshFileList() ");

			var path = $("#proRoot").attr("title") + $("#proName").attr("title");

			console.log("refreshFileList() path:" + path);

			//每次刷新 checkbox都设置为false
			$("#itemSelectedAll").prop("checked", false);

			showTips("Refreshing ....");

			var url = DEV_IP + path;
			$.get(url, "", function(result){
				console.log("result:" + JSON.stringify(result));

				if(result.state && result.state == "error")
				{
					showTips("path error or not exists !!!");
					$("#spanCount").html("0");
					clearFileList();
					setTimeout(function(){
						handleUpdateProRootAndName("/cmd");
						refreshFileList();
					}, 1000);
					
				}
				else
				{
					gJObjFileList = result;
					if (result.files.length <= 0) 
					{
						showTips("no files !!!");
						$("#spanCount").html("0");
						clearFileList();
					}
					else
					{
						showTips("Refresh end !", "success");
						updateFileList(result);
					}
				}
  			});

		}

		function clearFileList()
		{
			console.log("clearFileList()");
			$("#filelistBody").html("");
		}

		function fixSlash(src)
		{
			var len = src.length;
			var i = 0;
			var dst = "";
			var dstLen = dst.length;
			while(i < len)
			{
				dstLen = dst.length;
				if (i != 0 && dst[dstLen-1] == '/' && src[i] == '/') 
				{
					i++;
					continue;
				}
				else
				{
					dst += src[i];
					i++;
				}
			}
			lenDst = dst.length;
			if (lenDst != 1 && dst[lenDst-1] == '/') 
			{
				dst = dst.substring(0, lenDst-1);
			}
			return dst;
		}

		function handleUpdateProRootAndName(path)
		{
			console.log("handleUpdateProRootAndName()");
			var fixPath = fixSlash(path);
			var newProName = "";
			var newProRoot = fixPath;
			if (fixPath != "/cmd" && fixPath != "/data" && fixPath != "/web" && fixPath != "/access") 
			{
				console.log("handleUpdateProRootAndName() path:" + path + " fixPath:" + fixPath);
				//将一个完整的路径path 转换并更新当前 proRoot 和 proName, 包括title
				var pos = fixPath.lastIndexOf("\/") + 1 ;
				var len = fixPath.length;
				newProName = fixPath.substring(pos, len);
				newProRoot = fixPath.substring(0, pos);
				console.log("handleUpdateProRootAndName() newProName:" + newProName + " newProRoot:" + newProRoot);
			}
			updateProName(newProName);
			updateProRoot(newProRoot);
		}

		function updateProName(path)
		{
			console.log("updateProName() " + path);
			$("#proName").attr("title", path);
			$("#proName").val(path);
		}

		function updateProRoot(path)
		{
			console.log("uploadProRoot() " + path);
			pathLen = path.length;
			showPath = path;
			if($(window).width() >= 768)
       		{
       			//保留26个字符
       			//取前12个，后12个，中间3个点
       			if (pathLen > 26) 
       			{
       				showPath = "";
       				showPath += path.substring(0, 12);
       				showPath += "..."
       				showPath += path.substring(pathLen - 12);
       			}

       		}
       		else
       		{
       			//保留10个字符
       			//取前4个，后4个，中间3个点
       			if (pathLen > 10) 
       			{
       				showPath = "";
       				showPath += path.substring(0, 4);
       				showPath += "..."
       				showPath += path.substring(pathLen - 4);
       			}
       		}
       		$("#proRoot").attr("title", path);
       		$("#proRoot").html(showPath);
		}

		function onClickListOption(item)
		{
			if (isBusy()) {return;}
			var option = item.innerHTML;
			console.log("onClickListOption -- " + option);
			// if (option == "New Folder") 
			// {
			// 	showNewFolderDialog();
			// }
			if(option == "Upload")
			{
				showUploadDialog();
			}
			else
			{
				$("#spanOption").html(item.innerHTML);
			}
		}

		function showUploadDialog()
		{
			console.log("showUploadDialog");

			$("#uploadProgressbar").css("width", "0%");
			$("#uploadProgressValue").html("0%");
			$("#uploadChoosefile").val("");
			$("#uploadTitle").html("Upload");
			//MARK - modal 模态框，每次点击之后，都要设置为off，且不能点击空白关闭和键盘关闭，因为会出现点击后调用多次的问题；
			$('#uploadClose').click(function(){
				if (isBusy()) {return;}
				dismissUploadDialog();
			});

			$('#uploadNo').click(function(){
				if (isBusy()) {return;}
				dismissUploadDialog();
			});

			$('#uploadYES').click(function(){
				if (isBusy()) {return;}
				gIsUploading = true;
				uploadMultiFile(function(result, data){
					dismissUploadDialog();
					if (result == 1)
					{
						showTips("Upload End ...", "success");	
						refreshFileList();
					}
					else
					{
						showTips("upload error !!!", "danger");
					}
					gIsUploading = false;
				});
			});

			//不允许 点击空白处关闭，键盘关闭； 因为会积累重复提交的情况
			$('#modalUpload').modal({backdrop: 'static', keyboard: false});
			//代码调用 显示模态框的方法
			$('#modalUpload').modal("show");
		}

		function dismissUploadDialog()
		{
			console.log("dismissUploadDialog");
			$('#uploadClose').off();
			$('#uploadNo').off();
			$('#uploadYES').off();
			$('#modalUpload').modal("hide");
		}

		var xhrOnProgress=function(fun) {
		  xhrOnProgress.onprogress = fun; //绑定监听
		  //使用闭包实现监听绑
		  return function() {
		    //通过$.ajaxSettings.xhr();获得XMLHttpRequest对象
		    var xhr = $.ajaxSettings.xhr();
		    //判断监听函数是否为函数
		    if (typeof xhrOnProgress.onprogress !== 'function')
		      return xhr;
		    //如果有监听函数并且xhr对象支持绑定时就把监听函数绑定上去
		    if (xhrOnProgress.onprogress && xhr.upload) {
		      xhr.upload.onprogress = xhrOnProgress.onprogress;
		    }
		    return xhr;
		  }
	    }

		function uploadMultiFile(callback) {

	    	console.log("uploadMultiFile()");

	    	var countFile = $('#uploadChoosefile')[0].files.length;

	    	if (countFile <= 0) 
	    	{
	    		console.log("no file choosen !!!");
		    	showUploadDialogTips("no upload file !!!");
		    	gIsUploading = false;
		    	return;
	    	}

	    	var fileName = "";
	    	var fileSize = 0; 
	    	var pattern = /^\w{1,}[a-zA-Z0-9_\.]{1,}$/;
		    for(var i = 0; i < $('#uploadChoosefile')[0].files.length; i++)
		    {
		    	fileName = $('#uploadChoosefile')[0].files[i].name;
		    	fileSize = $('#uploadChoosefile')[0].files[i].size;
		    	console.log( "[" + i + "]" + fileName + " size:" + fileSize);

				// if(!fileName.match(pattern))
				// {
				// 	console.log("file name:" + fileName + " not right!!!");
				// 	showUploadDialogTips("upload file name not permit !!!");
				// 	gIsUploading = false;
				// 	return;
				// }
		    }

		    startUploadFile(0, callback);
		}

		function startUploadFile(index, callback)
		{
			console.log("startUploadFile() index:" + index + " " + $('#uploadChoosefile')[0].files[index]);
			if ($('#uploadChoosefile')[0].files[index] == undefined) 
			{
				//upload end
				callback(1);
			}
			else
			{
				var fileName = $('#uploadChoosefile')[0].files[index].name;
		    	var fileSize = $('#uploadChoosefile')[0].files[index].size;
		    	console.log("startUploadFile() index:" + index + " name:" + fileName + " size:" + fileSize);

		    	var pathname = fixSlash($("#proRoot").attr("title") + $("#proName").val());
			    var reqURL = DEV_IP + "/upload" + "?path=" + pathname + "&name=" + fileName + "&filesize=" + fileSize;
			    console.log("uploadFile filename:" + fileName + " size:" + fileSize + " url:" + reqURL);
			    var formdata = new FormData();
			    formdata.append('file', $('#uploadChoosefile')[0].files[index]);
		  		$("#uploadProgressbar").css("width", "0%");
   			    $("#uploadProgressValue").html("0%");
   			    $("#uploadTitle").html("Upload-" + fileName+"(" + (index+1) +"/" + $('#uploadChoosefile')[0].files.length + ")");
			    $.ajax({
		           url: reqURL,
		           data: formdata,
		           type: "Post",
		           dataType: "json",
		           cache: false,//上传文件无需缓存
		           processData: false,//用于对data参数进行序列化处理 这里必须false
		           contentType: false, //必须
		           xhr:xhrOnProgress(function(e){
		   			  var percent=e.loaded/e.total;
		   			  percent = parseInt(percent * 100);
		   			  percent = percent + "%";
		   			  $("#uploadProgressbar").css("width", percent);
		   			  $("#uploadProgressValue").html(percent);
		   			  console.log(percent);
		   		   }),
		           success: function (result) {
		               console.log(JSON.stringify(result));
		               startUploadFile((index+1), callback);
		           },
		           error: function(result){
		           	   console.log("upload error rtn:" + JSON.stringify(result));
		               callback(0);
		           }
	        	});
	    	}
		}


		var showUploadDialogTipsTimer;
		function showUploadDialogTips(msg, timeout=3000)
		{
			console.log("showUploadDialogTips() " + msg);
			//clear timer
			clearTimeout(showUploadDialogTipsTimer);
			$("#uploadTips").html(msg);

			showUploadDialogTipsTimer = setTimeout(function(){
				console.log("showUploadDialogTipsTimer timeout ----");
				$("#uploadTips").html("");
				clearTimeout(showUploadDialogTipsTimer);
			}, timeout);
		}

		function updateFileList(jsonObj)
		{
			console.log("updateFileList()");
			var path = jsonObj.path;
			var aryFiles = jsonObj.files;
			var count = jsonObj.files.length;
			var mIndex = 0;

			var outName = "";
			var outUrlDownload  = "";
			var outUrlShow = "";
			var outPathDev = "";
			var outSize = 0;
			var isSubDir = 0;
			var outLogUrl = "";
			var newHtml = "";

			for(mIndex = count - 1; mIndex >= 0; mIndex--)
			{
				tmpItem = aryFiles[mIndex];
				outName = tmpItem.name;
				outPathDev = path + "/" + outName;
				outUrlShow  = DEV_IP + outPathDev;
				outUrlDownload = outUrlShow + "?download";
				isSubDir = 0;
				if (tmpItem.size == -1) 
				{
					outSize = "Document";
					isSubDir = 1;
				}
				else
				{
					outSize = getFileSize(tmpItem.size);	
				}

				if(outName.lastIndexOf(".log") >= 0){
					outUrlShow = DEV_IP + "/web/log.html?path=" + outPathDev;
				}
				newHtml += generateFileItem(outName, outSize, isSubDir, outUrlDownload, outUrlShow);
				//console.log("outName:" + outName + " outUrl:" + outUrl + " outUrlShow:" + outUrlShow + " outPathDev:" + outPathDev);
			}
			$("#spanCount").html(count);
			$("#filelistBody").html(newHtml);
			updateItemBtnsSize();
		}

		function goBack()
		{
			if (isBusy()) {return;}
			console.log("goBack()");
			pathRoot = $("#proRoot").attr("title");
			proName  = $("#proName").attr("title");
			// if (pathRoot == "/mnt/DCIM/" && proName == "") 
			if ((pathRoot == "/cmd" && proName == "") || (pathRoot == "/web" && proName == "") || (pathRoot == "/data" && proName == ""))
			{
				//本来就是根目录
				console.log("is already /web/ or /cmd/ or /data/");
			}
			else if(pathRoot == "/access/" && proName.length == 1)
			{
				console.log("is access root");
			}
			else
			{
				nowPath = pathRoot + proName
				//最后一个路径的名字
				handleUpdateProRootAndName(pathRoot);
				refreshFileList();
			}

		}

		function handleItemName(name)
		{
			var maxLen = 50;
			var nameLen = name.length;
			var showName = name;
   			//取前12个，后12个，中间3个点
   			if (nameLen >= maxLen) 
   			{
   				showName = "";
   				showName += name.substring(0, ((maxLen-3)/2));
   				showName += "..."
   				showName += name.substring(nameLen - ((maxLen-3)/2));
   			}

			return showName;
		}

		function generateFileItem(name, size, isDir, urlDownload, urlShow)
		{
			//console.log("updateFileList()");
			var itemValue = "<tr>";
		    itemValue += "<td><input name=\"item_check\" type=\"checkbox\" onclick=\"onClickItemCheck()\"></td>";
		    imgTarget = "_blank";
			
		    if(isDir == 1)
		    {
		    	itemValue += "<td><a href=\"javascript:void(0)\" onclick=\"onClickSubDir('" + name + "')\"><span class=\"item_name\" style=\"color:#3f77c4;\" title=\"" + name + "\">" + handleItemName(name) + "</span></a><br/><span class=\"item_size\">" + size + "</span></td>";
		    }
		    else
		    {
		    	itemValue += "<td><a href=\"" + urlShow + "\" target=\"" + imgTarget + "\"><span class=\"item_name\" style=\"color:#3f77c4;\" title=\"" + name + "\">" + handleItemName(name) + "</span></a><br/><span class=\"item_size\">" + size + "</span></td>";
		    }
		    itemValue += "<td>";

		    if(!isDir)
		    {
	    		itemValue += "<button class=\"btn btn-warning item_btn item_btn1\" title=\"Download\" onclick=\"onClickDownload(" + "'" + urlDownload + "')\"><span class=\"glyphicon glyphicon-download-alt\"></span></button>&nbsp;";
			}
			// if(!isOpt)
			// {
		    	// itemValue += "<button class=\"btn btn-info item_btn item_btn2\" title=\"Rename\" onclick=\"onClickRename('" + name + "')\"><span class=\"glyphicon glyphicon-edit\"></span></button>";
		    // }
		    itemValue += "</td>";
		    itemValue += "</tr>";

		    return itemValue;
		}

		function getFileSize(fileByte) {
		    var fileSizeByte = fileByte;
		    var fileSizeMsg = "";
		    if (fileSizeByte < 1048576) fileSizeMsg = (fileSizeByte / 1024).toFixed(2) + "KB";
		    else if (fileSizeByte == 1048576) fileSizeMsg = "1MB";
		    else if (fileSizeByte > 1048576 && fileSizeByte < 1073741824) fileSizeMsg = (fileSizeByte / (1024 * 1024)).toFixed(2) + "MB";
		    else if (fileSizeByte > 1048576 && fileSizeByte == 1073741824) fileSizeMsg = "1GB";
		    else if (fileSizeByte > 1073741824 && fileSizeByte < 1099511627776) fileSizeMsg = (fileSizeByte / (1024 * 1024 * 1024)).toFixed(2) + "GB";
		    else fileSizeMsg = "文件超过1TB";
		    return fileSizeMsg;
		}

		function updateItemBtnsSize()
		{
			console.log("updateItemBtnsSize()");
			//更新 按钮的大小
       		var classAttr1 = "btn btn-warning btn-xs item_btn item_btn1";
       		var classAttr2 = "btn btn-info btn-xs item_btn item_btn2";
       		if($(window).width() >= 768)
       		{
       			classAttr1 = "btn btn-warning item_btn item_btn1";
       			classAttr2 = "btn btn-info item_btn item_btn2"
       		}
       		$(".item_btn1").attr("class", classAttr1);
       		$(".item_btn2").attr("class", classAttr2);
		}

		function onClickSubDir(name)
		{
			if (isBusy()) {return;}
			console.log("onClickSubDir() name:" + name);
			var nowPath = $("#proRoot").attr("title") + $("#proName").attr("title") + "/" + name;
			console.log("onClickSubDir() nowPath:" + nowPath);
			handleUpdateProRootAndName(nowPath);
			refreshFileList();
		}

		function isPC() {
		    var userAgentInfo = navigator.userAgent;
		    //alert(userAgentInfo);
		    var Agents = ["Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod"];
		    var flag = true;
		    for (var v = 0; v < Agents.length; v++) {
		        if (userAgentInfo.indexOf(Agents[v]) > 0) {
		            flag = false;
		            break;
		        }
		    }
		    return flag;
		}
		  

		function onClickDownload(url)
		{
			if (isBusy()) {return;}
			console.log("onClickDownload:" + url);
			//alert("isPC:" + isPC());
			if (isPC()){
				//电脑端直接弹出下载
				window.open(url);
			}else{
				showTips("Sorry, Plz download via PC browser ！！！");				
			}
		}

		function onClickItemCheck()
		{
			console.log("onClickItemCheck()");
			var arySelectedFiles = getSelectedFiles();
			var selectedLen = arySelectedFiles.length;
			var fileCount   = gJObjFileList.files.length;
			console.log("onClickItemCheck() selectedLen:" + selectedLen + " fileCount:" + fileCount); 
			if (selectedLen == fileCount) 
			{
				// document.getElementById("itemSelectedAll").checked = true;
				$("#itemSelectedAll").prop("checked", true);
			}
			else
			{
				$("#itemSelectedAll").prop("checked", false);
				// document.getElementById("itemSelectedAll").checked = false;
			}

			if (selectedLen == 0) 
			{
				$("#spanCount").html(fileCount);
			}
			else
			{
				$("#spanCount").html( selectedLen + "/" + fileCount);
			}			
		}

		function onClickSelectAll(item)
		{
			console.log("onClickSelectAll() checked:" + item.checked);
			var arySelectedFiles = getSelectedFiles();
			var selectedLen = arySelectedFiles.length;
			var fileCount   = gJObjFileList.files.length;
			console.log("onClickSelectAll() - selectedLen:" + selectedLen + " fileCount:" + fileCount);
			var aryItemChecks = $("input[name='item_check']");
			console.log("aryItemChecks len:" + aryItemChecks.length);
			for(var i = 0; i < aryItemChecks.length; i++)
			{
				aryItemChecks[i].checked = item.checked;
			}
			if (item.checked) 
			{
				$("#spanCount").html( fileCount + "/" + fileCount);
			}
			else
			{
				$("#spanCount").html(fileCount);
			}
		}

		function getSelectedFiles()
		{
			console.log("getSelectedFiles()");
			var nowPath = fixSlash($("#proRoot").attr("title") + "/" + $("#proName").attr("title"));
			console.log("getSelectedFiles() nowPath:" + nowPath);
			var arySelectedFiles = [];
			var aryItemNames = $(".item_name");
			console.log("aryItemNames len:" + aryItemNames.length);
			// for debug
			// for(var i = 0; i < aryItemNames.length; i++)
			// {
			// 	obj = aryItemNames[i];
			// 	console.log("aryItemNames[" + i + "]:" + $(obj).html());
			// }
			var aryItemChecks = $("input[name='item_check']");
			console.log("aryItemChecks len:" + aryItemChecks.length);
			for(var i = 0; i < aryItemChecks.length; i++)
			{
				obj = aryItemChecks[i];
				//for debug
				//console.log("aryItemChecks[" + i + "]:" + obj.checked);
				if (obj.checked) 
				{
					filePath = nowPath + "/" + $(aryItemNames[i]).attr("title");
					arySelectedFiles.push(filePath);
				}
			}

			console.log("getSelectedFiles() arySelectedFiles:" + arySelectedFiles);
			return arySelectedFiles;
		}

		function onClickRootPath(item)
		{
			if (isBusy()) {return;}
			var oldPath = $("#proRoot").attr("title");
			var path    = item.innerHTML;
			console.log("onClickRootPath() oldPath:" + oldPath + " path:" + path);
			if(oldPath == path)
			{
				//一样的就不管了
				console.log("select the same path!");
				return;
			}
			else
			{
				//不一样的
				updateProRoot(path);
				updateProName("");
				if(path == "/access"){
					updateProRoot("/access/");
					updateProName("c")
				}
				refreshFileList();
			}
		}

		function onClickRefresh()
		{
			if (isBusy()) {return;}
			console.log("onClickRefresh()");
			pathRoot = $("#proRoot").attr("title");
			pathProName = $("#proName").val();
			handleUpdateProRootAndName(pathRoot + "/" + pathProName);
			refreshFileList();
		}

		function onClickConfirm(btn)
		{
			if (isBusy()) {return;}
			console.log("onClickConfirm() " + $(btn).html());
			if ($(btn).html() == "Upload") 
			{
				showUploadDialog();
				return;
			}
			var aryFiles = getSelectedFiles();
			var selectedLen = aryFiles.length
			if(selectedLen <= 0)
			{
				console.log("onClickConfirm() select none!!!");
				showTips("no file selected !!!", "danger");
				return;
			}
			var option = $("#spanOption").html();
			console.log("onClickConfirm() - option:" + option);
			if (option == "Delete") 
			{
				showDeleteDialog(aryFiles);
			}
			// else if(option == "Move")
			// {
			// 	showMoveDialog(aryFiles, 0);
			// }
			// else if(option == "Compress")
			// {
			// 	showCompressDialog(aryFiles);
			// }
			// else if(option == "Copy")
			// {
			// 	showMoveDialog(aryFiles, 1);
			// }
		}

		function showDeleteDialog(selectedFiles)
		{
			console.log("showDeleteDialog() - " + selectedFiles);

			//修改模态框的内容以及点击操作
			// var bodyHtml = "<span><span style=\"color: #f00;\">DELETE</span>&nbsp; " + name + "&nbsp;?</span>";
			// $('#modalDeleteBody').html(bodyHtml);

			//MARK - modal 模态框，每次点击之后，都要设置为off，且不能点击空白关闭和键盘关闭，因为会出现点击后调用多次的问题；
			$('#deleteClose').click(function(){
				dismissDeleteDialog();
			});

			$('#deleteNo').click(function(){
				dismissDeleteDialog();
			});

			$('#deleteYES').click(function(){
				dismissDeleteDialog();
				gIsDeleting = true;
				var selectedLen = selectedFiles.length;
				showTips("Deleting ...", "warning", (selectedLen  * 1000));
				var countDelEnd = 0;
				var tmpUrl = "";
				var tmpPath = "";
				for(var i = 0; i < selectedLen; i++){
					tmpPath = selectedFiles[i];
					tmpUrl = DEV_IP + tmpPath + "?delete";
					console.log(i + ",url:" + tmpUrl);
					$.get(tmpUrl, "", function(result){

						console.log(i + ",delete ret:" +  JSON.stringify(result))
						countDelEnd++;
						if(countDelEnd >= selectedLen)
						{
							showTips("Deleting End !", "success");
							refreshFileList();
							gIsDeleting = false;
						}

					});
				}
			});

			//不允许 点击空白处关闭，键盘关闭； 因为会积累重复提交的情况
			$('#modalDelete').modal({backdrop: 'static', keyboard: false});
			//代码调用 显示模态框的方法
			$('#modalDelete').modal("show");
		}

		function dismissDeleteDialog()
		{
			console.log("dismissDeleteDialog");
			$('#deleteClose').off();
			$('#deleteNo').off();
			$('#deleteYES').off();
			$('#modalDelete').modal("hide");
		}

		var showTipsTimer;
		function showTips(msg, level="warning", timeout=3000)
		{
			console.log("showTips:" + msg);

			//clear timer
			clearTimeout(showTipsTimer);
			var btnHtml = "<button type=\"button\" class=\"close\" onclick=\"closeTips('" + level + "')\"><span aria-hidden=\"true\">&times;</span></button>";
			$("#alertTips").html(btnHtml + msg);
			var classAttr = "alert alert-" + level + " fade in"
			$("#alertTips").attr("class", classAttr);

			showTipsTimer = setTimeout(function(){
				console.log("showTips timeout ----");
				var classAttr = "alert alert-" + level + " fade out hidden";
				$("#alertTips").attr("class", classAttr);
				clearTimeout(showTipsTimer);
			}, timeout);

		}

		function closeTips(level)
		{
			console.log("closeTips ----");
			var classAttr = "alert alert-" + level + " fade out hidden";
			$("#alertTips").attr("class", classAttr);
			clearTimeout(showTipsTimer);
		}

	</script>
</body>
</html>